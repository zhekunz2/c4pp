import pyro, numpy as np, torch, pyro.distributions   as dist, torch.nn as nn
from pyro.optim import Adam
import torch.distributions.constraints as constraints
from pyro.infer import SVI
if pyro.__version__ > '0.1.2': from pyro.infer import Trace_ELBO
from pyro.contrib.autoguide import *
import math
def amb(x):
    return x.data.numpy().tolist() if isinstance(x, torch.Tensor) else x
y= np.array([-2.01252754363, -2.2174985801, -1.38770436083, -2.22450116216, -3.02739788044, -2.81808028251, -3.02645803355, -2.06076362743, -0.887779948774, -1.83217209576, -1.05774747101, -1.35775631106, -1.59722399394, -1.591060291, -1.12121652955, -1.36090470158, -2.61189824936, -2.99170766599, -1.6793191635, -2.2217945799, -1.85727854281, -1.29940795771, -2.29473489524, -2.97202595802, -3.2003702996, -2.97948926343, -1.23910989655, -1.79788785449, -1.96780541832, -1.27571601487, -0.243318371141, -1.66776125237, -0.958738799234, -1.23967004858, -2.25049023765, -2.63860265, -2.57467410734, -1.45566945713, -1.42006774839, -1.03963019029, 0.00310970883323, -0.397217076809, -0.432003629602, -0.598513540805, -0.63949043585, -2.08220151898, -1.95010351498, -0.86354599737, -2.06995596164, -0.290748597799, -1.5155676275, -3.55855423856, -2.77300084113, -2.60868731081, -2.31226383427, -2.7603527618, -3.47007531616, -3.09179575343, -2.89724806363, -1.82015380233, -2.42579745498, -1.6720190232, -1.20601997211, -0.625862170914, -1.07412389888, -0.28419476485, -1.09744193028, -2.18955458696, -2.75983608026, -1.31074306626, -1.73128708014, -3.1999272265, -2.27490232733, -1.65841871954, -0.0843985799198, -0.205699677385, -1.72217217055, -2.91773113258, -3.06545211562, -1.66286208767, -1.63958859664, -2.47360226328, -1.11439124959, -0.829252947106, -1.4671115502, -0.725865465415, -0.71262182006, -0.199945509944, -0.0322938984425, -1.68848602762, -1.88456239566, -1.36204171334, -1.93062442264, -1.77296032741, -2.05926614929, -0.853379597382, -1.74221845331, -2.05595234864, -1.73547218001, -1.7181543879, -2.10308209946, -1.87575326779, -1.25078397886, -1.16656321946, -1.73883229188, -2.49570129642, -1.34710469766, -1.00994612947, -1.2632575224, -0.281665706904, -0.54541793877, 0.734289284102, 0.125124945805, -0.810654867956, -1.29020454065, -1.38102779811, -2.21687947039, -2.46302716001, -1.76752089796, -1.34739305694, -1.04533165523, -2.32001855525, -3.64890829748, -3.22174062232, -2.80975605158, -2.64894379273, -1.97798692619, -1.87975869757, -1.26635353355, -0.296833569085, -1.43585605887, -2.5588483931, -1.33926985715, -0.109622921183, -1.92415054878, -2.33602637945, -1.88639242932, -1.30368616646, -2.25251464456, -2.5160464904, -1.37879084853, -0.955889233675, -1.41586067041, -1.52546418625, -0.516610611284, 0.317888084932, -1.03984763973, -2.1385902996, -1.55833455317, -1.33778240188, -0.351727110567, -1.85956929092, -1.72192378309, -2.10214738995, -2.66931601065, -2.08643945333, -0.930866474216, -1.3900138168, -1.97492366747, -1.58989863242, -2.49505988575, -3.01283077134, -2.54920725347, -2.52789425971, -2.03215805549, -1.17208983918, -0.663003973075, -2.17486092633, -1.34359404776, -0.435203634887, -1.55833530107, -0.0805444828324, -1.12466341145, -1.65401697611, -1.22107474267, -0.489114292609, -0.641964733249, -2.81446236531, -2.42233795617, -1.04881528931, -1.20649069247, -2.96372621678, -3.62159741823, -1.56088188808, -1.38342762628, -1.59026162757, -2.92875831943, -2.59766086964, -1.85804851441, -2.2331480359, -2.01739194045, -0.875747327479, -1.24338271623, -0.361759031074, -0.861313453925, -0.522160351544, -1.04836356622, -2.22877200062, -2.49514522384, -2.81028242732, -1.93787954561, -1.68108418063, -2.01419397479, -1.19551908025, -0.92752773017, -1.07681181966, -0.564420835699, -1.01440050452, -0.669151191948, -1.58669067814, -1.44270614335, -2.90107932812, -2.47155817372, -1.55155557189, -1.17999907905, -2.90329918938, -2.23699888839, -2.2953930845, -2.58886658657, -2.01382016286, -0.0886510479087, -0.541780575669, -2.3408215254, -2.44420019574, -1.42006118483, -0.889511053344, -1.07633263851, -1.71476519407, -2.08434309492, -1.7797522793, -0.688772363822, -1.87493684598, -1.78816116365, -2.7934454073, -2.77695177651, -2.34707277918, -2.10658758394, -1.88673406283, -2.22496584582, -1.72681317601, -1.40918014257, -1.79538675255, -2.66876718536, -1.75942345807, -0.721998611398, -1.30336385731, -0.27668634615, -1.22907808306, -0.529069450385, -1.61577005113, -1.19448262043, -0.967157984212, -2.06286179282, -3.910710299, -3.49062261217, -2.82861397333, -3.35565897183, -2.60881119093, -0.970335925184, -0.643648198912, -0.911362692725, -1.26459690651, -1.07284491183, -1.568997626, -2.52226006554, -3.01878723934, -2.23111817357, -2.07554489073, -1.97911287158, -1.54213123354, -0.50671962041, 0.56112358722, 0.153203501863, -2.16014179554, -1.59338776021, -1.47943174939, -2.30868524247, -1.89430516594, -0.934578419567, -0.966734138864, -0.586213371993, -0.80766478321, -1.15284689494, -2.07487321164, -2.57133348923, -3.36612445205, -2.72957211238, -2.08271592967, -2.95180079024, -2.47726231798, -1.90137475028, -1.96913255032, -2.4317188528, -1.21482369173, -1.73044267674, -2.07562680818, -2.16422325091, -0.473989132902, 0.174863929082, -0.847434885917, -2.64984005857, -2.26496603376, -0.949697440685, -1.1539211385, -2.14840266941, -2.58423374846, -3.5074537251, -2.09958323356, -1.96846299465, -2.13261935676, -2.14421175034, -2.27638840123, -1.88554685203, -1.90621444869, -2.03019447965, -2.67623498072, -1.84998903018, -2.30548197695, -1.83928456903, -1.41200001954, -1.06336869446, -0.755171761283, -1.24865198927, -1.63181291933, -1.96722118773, -2.77718233966, -1.42385536472, -1.6197734691, -1.91026990158, -0.899181685439, 0.352728933703, 1.13458283604, -1.25050727675, -3.12029199202, -1.34268886269, -1.15546022177, -2.28706628564, -2.04355885393, -1.62805816343, -1.26410846199, -0.854489721701, -1.33429228274, -1.29790022661, -1.31354303318, -1.67030800331, -2.14479418095, -3.12862605419, -3.3379697255, -2.3054274854, -1.91003207639, -2.05661258372, -0.919614927529, -1.03854018863, -0.996665763738, -2.36697838246, -3.08895837618, -2.33095807117, -1.92794180204, -1.85257911002, -1.45135132141, -0.818496042606, -0.765074128888, -0.532284110843, -0.687065964264, -1.65525554246, -2.4928528319, -1.07704279387, -1.48076100353, -2.14145735978, -3.29936202542, -2.8507510625, -2.54448129483, -0.0685621775652, -0.442298418493, -1.43705127996, -2.22866999283, -2.14530934354, -1.65812915951, -0.780365235757, -1.25475885582, 0.437279888336, -0.590532539666, -1.18093466631, -1.82596149338, -1.23873346729, -1.53262269043, -1.94826266036, -1.35586525888, -0.36838543442, -1.22840558197, -2.35818890975, -2.57568751549, -3.87378929726, -2.44711963345, -1.80238581447, -2.22866470869, -1.62218535094, -1.93542656627, -0.869893412522, -1.29035810066, -1.73173406576, -2.5019196354, -2.79596184216, -2.54788243648, -1.89042523404, -2.12256450496, -0.211296382554, -0.674472499234, -2.73033956132, -3.61124452242, -3.60017250011, -1.93730391761, -1.55321500529, -2.39896261732, -2.43242472807, -0.816674716725, -1.11679310859, -1.80735486767, -1.88933085251, -2.23840057685, -2.13270654178, -2.13049862393, -1.81513023416, -2.92650021269, -2.44618757451, -1.95956083533, -1.73692870614, -2.64984260148, -2.13457260225, 0.0649306778074, -1.24018593074, -1.78645391554, -2.02179323836, -2.03617909266, -2.4549991313, -3.674389534, -3.25279171547, -1.48704038834, -0.377835862807, 0.199000772317, -1.33548852454, -1.94349834561, -1.14398256358, -1.64447105798, -2.86967466313, -1.8994922852, -0.165900230237, -0.781055141646, -2.63785552001, -2.92905661861, -1.89509755527, -0.443644975367, -0.681876356402, -0.625445955936, -0.599988397753, -1.80149663546, -1.73699095015, -0.902949210238, -2.03580706316, -1.11551288008, -2.2485543587, -2.16556726663, 0.646081286773, 0.853027285115, -0.171866759612, -0.994097813807, -2.12474433597, -1.30166115409, -1.1549181977, -2.82076010946, -3.37884704142, -2.9403442197, -2.04391987191, -1.26687154812, 0.14577041811, -1.28887606928, -2.08806533024, -1.9505813881, -1.40356813285, -2.20610621756, 0.590139782656, 0.618530060093, -1.56967891677, -0.679631646344, -0.34688332874, -0.898488005196, -0.458443681203, -0.542355038313, -0.383305809216, -0.800431461798, -1.97712928248, -0.362273685868, 1.59729882794, 0.363285766604, -1.78121024446, -2.79656575716, -1.8249045807, -1.40077581667, -1.36289140284, -0.963093138494, -1.56805169831, -2.02823878852, -1.29318008049, -1.64559891854, -1.01963153212, -1.54098334206, -0.717528484493, -1.69135009453, -1.48811415027, -1.69577300223, -0.426529006102, -0.861266575866, -0.651143535183, -0.796423377376, -2.30455035458, -3.00980331376, -3.09888153195, -3.60030417966, -2.92851724615, -2.38839987142, -2.08383568553, -1.84756449758, -1.05368528844, -0.885393277531, -0.552996414993, -1.8784980221, -3.92862443506, -3.19230936424, -1.62716597097, -1.61085829879, -1.01171585843, -1.40837874834, -0.652907300538, -1.59268961795, -0.921051099632, -1.07439041785, -2.17412339504, -2.44956293104, -1.54821594444, -2.28319358746, -3.08679870272, -1.91268346154, -0.415389464163, 0.669456617, 0.228225652881, -1.38689876774, -2.15483584961, -3.06706252725, -3.02993156913, -2.00966662372, -0.823313288315, -1.60410618516, -1.95481531931, -0.413548320447, -0.473276943705, -1.84112256221, -1.83240865024, -2.25867201941, -1.3846423436, -2.11670839489, -1.80656731356, -0.943966747406, -1.82033174121, -2.95846926085, -0.678424858001, 0.148044990063, 0.439851099141, 0.107058511052, -1.69831933682, -2.02815711345, -1.54652024438, -1.86475335735, -1.55884296089, -0.856136567373, -1.72673507096, -2.13284385808, -1.68955683214, -0.240760576856, 0.436735061034, -0.734173424996, -1.42200014037, -0.699553577467, -0.53605324474, 0.574659418669, 0.251539444433, -0.612290385375, -2.43370975377, -1.99612200073, -1.48384324986, -0.568044241359, -1.99707297425, -0.9751830695, -1.63815797323, -2.51187908469, -3.45406136505, -1.97634609225, -1.13844031397, -1.03802366818, -2.49314924036, -2.15016710222, -0.450453581155, -0.60804978787, -1.09949238548, 0.4142697258, -0.105596127842, -0.380924811329, -0.89351867234, -1.43338950785, -2.05803221869, -1.31443048012, -0.623219015703, -1.38803100343, -1.483534097, -0.831255394367, -0.767279856825, -2.09566451336, -1.45759643558, -2.0290981412, -2.01364432951, -2.45294294864, -1.91348325576, -0.661651573244, -1.19828293001, -1.33931342711, -1.23347135319, 0.225227450788, -0.138080039731, -1.00738977744, -1.44726812425, -0.921988839998, -0.789599525415, -0.444205995929, -1.92641195326, -3.64944586512, -1.99910921585, -1.22809865201, -1.17443033171, -1.7430075351, -2.17571310882, -1.54326281816, 0.6429655895, -0.272708547598, -1.56393864981, -2.32716203378, -3.92155480599, -0.217511927931, 0.599456988804, -1.34677724337, -2.0255113956, -1.44765395726, -2.51184652673, -1.21165685603, -1.03948463866, -1.52489202248, -2.38538324208, -2.48030568979, -1.74250536115, -0.731271814669, -2.38814010527, -2.94952743316, -2.15457854117, -2.05389737108, -1.60563761256, -0.165666577785, -0.787835037445, -1.88113116046, -1.06919946866, -1.36937950618, -4.30983154754, -2.83213074729, -1.46274914531, -1.12235701042, -1.20068109286, -0.353720450231, -0.364290674686, 0.362285386208, 0.183885488026, -0.845826586164, -2.51569532626, -1.46781794597, -1.40184452021, -1.75565452471, -1.67791151181, -1.17303020984, -2.48387494528, -2.3363584798, -2.08086515364, -1.96887160033, -3.19754766187, -2.85826324313, -3.0995297514, -1.51979155046, -1.21920590129, -1.30739745265, -2.38897484924, -2.8494879052, -1.38625019774, -0.474063324029, -0.895954656726, -0.82530394434, -0.586480151778, -1.45472391565, -2.07379938246, -1.71050336129, -1.43328873609, -1.83500645341, -2.49399059584, -1.61779033324, -2.4295393569, -1.45001887699, -0.51817967649, -1.36694080852, -0.570987746041, -0.900282014928, -2.35648370696, -1.80825499017, -1.79267896406, -2.42342327456, -2.14643817204, -2.60576937019, -3.80211595404, -2.36373468504, -2.09754948931, -1.62896983584, -3.2972880383, -2.93083236642, -1.49898434728, -0.367888838978, -0.447601379425, -1.04529935002, -2.48207178869, -1.78372592113, -1.07368674613, -0.835015073329, -1.89725100768, -2.77298564131, -0.871323675764, -1.03932821898, -1.5612551009, -2.46811554568, -2.69948123832, -2.08551290727, -2.68488791931, -0.486694942961, 0.207353313825, 0.165732452727, -1.94568880433, -1.55980355628, -2.16910397555, -2.45164551579, -1.4910881991, -1.2008115471, -1.36923011438, -0.834104224379, -0.177298906828, -2.07558680841, -2.25988454865, -0.421191770811, -0.157612955935, -1.58134708793, -2.56645080511, -2.16936817694, -0.736740740349, -1.04203373507, -1.67923995268, -1.37570224747, -1.03033101063, -2.15415300365, -1.44047055645, -0.459340004967, -1.61288259261, -3.58273322188, -2.75987401872, -1.56635419925, -1.25711895163, -2.19302708457, -1.73822023402, -0.722992669892, -0.694447245351, -1.32878007385, -0.319222498829, -0.118340448935, -2.44530626026, -1.65008932686, 0.0834408145085, -0.672207895413, -0.486910211627, 0.888042933051, -0.717003421615, -1.78325017499, -2.51107322089, -2.08578463481, -1.44075409456, -1.78360388745, -1.04453741983, -0.722716930564, -1.0531898824, -2.06453758536, -0.0388014587287, -0.485238658195, -2.12616875763, -1.35125903219, 0.56536549492, 0.175396174642, -1.70795166357, -1.95704472541, -1.37304098626, -2.81927664922, -2.83866788495, -2.47182477295, -1.97798750568, -2.08509326137, -0.895172499424, -1.42246090052, -1.56007689693, -1.78201706747, -2.30888013772, -2.72920056063, -1.93921241234, -1.55850173614, -2.43396296923, -2.10099572263, -1.87732544199, -1.40388470804, -0.143642188034, -0.582637762288, -2.21959801467, -1.51787662053, -1.5891372245, -1.75548879656, -1.90350105613, -1.91556872338, -1.95560713531, -1.82070449961, -2.2982373977, -2.27428111625, -1.43601677009, -2.0508655053, -3.47804075977, -3.60261260074, -1.15926576337, -1.97718258069, -1.30349178906, -1.18886464663, -1.86178884271, -2.56689647954, -2.87097377893, -2.12019014866, -2.64182556266, -2.08588641454, -2.16349422743, -2.57825885809, -1.15890287325, -2.14586946651, -3.17986232278, -2.4769768062, -1.52968827729, -0.748001027966, 0.0102297634645, -0.508864590006, -1.22961784141, -1.12018966809, -1.46402000895, -1.53201715419, -2.00423552709, 0.321388483981, -0.0560509374954, 0.331517766052, -1.08181359297, -3.06740172433, -2.18706730603, -1.6978613437, -0.232436261091, 0.110273209912, 0.13693884486, -0.773733763866, -2.27352865556, -2.24444505965, -2.29904938576, -1.41363807421, -1.13074842405, -2.54681924542, -3.15641755734, -2.7096700318, -2.3997968435, -2.35824450592, -2.66963539551, -2.5165266387, -2.35190498219, -1.28236254465, -1.43205324536, -2.60442186336, -2.51265794831, -2.36522718126, -1.53166656611, -0.851544659118, -1.10311731391, -0.377160233529, -0.276787666187, -1.5753225303, -4.37465980098, -3.38652343246, -1.63302068423, -1.72670221641, -1.52606522395, -1.77619030816, -1.82567452117, -1.4971013982, -0.54196568184, -1.81008479216, -1.50514573531, -1.07028926006, -0.957850508905, -1.03542570622, -1.20646376277, -0.925306415641, -0.942964373724, -0.751437985963, -1.75661559794, -1.83245639, -1.85285380752, -1.68665810698, -1.44412869961, -1.62659456197, -0.93331139104, -2.0665598843, -2.67012589439, -1.85774180152, -2.44994328291, -0.991567331942, -0.36734126354, -0.7363657233, -2.15397801789, -2.98377546239, -2.39895397487, -2.25754812447, -1.70789210866, -2.46388660017, -3.03941099671, -1.62018349491, -0.84449348403, -0.584072105974, -1.27176439207, -1.92974925458, -1.59974206635, -1.50759809502, -2.64298354918, -3.18320479506, -2.86720812053, -2.15019823836, -2.77357950688, -2.83575435506, -1.17934933616, -1.17708177155, -0.9661985661, -2.25551817477, -1.73140305136, -1.61252952296, -2.33141764118, -1.96496145644, -1.75027691119, -1.25961978855, -0.637463473829, -1.22902484976, -1.87193868707, -1.23010854921, -1.98184208893, -1.21636347857, -1.03647726307, -0.85013867276, -0.495233413703, -1.70628084385, -1.11921270481, -0.421037923393, -1.2944479465, -2.53552938236, -3.92544200187, -3.60630380105, -2.4830769315, -1.79511544029, -1.0434988589, -0.915881997062, -3.4077530118, -3.58554214527, -1.08114939698, -0.67337944076, -1.40218000869, -2.31433260945, -3.041667579, -1.76054103769, -1.11650409305, -2.1288560691, 0.410421208615, 1.01750063299, -0.875861691697, -2.13414782473, -1.85345719714, -1.35113828448, -0.925850223433, -1.53515698436], dtype=np.float32).reshape(1000,1)
y=torch.tensor(y)
T=1000
T=torch.tensor(T)
def model(y,T):
    nu = torch.zeros([amb(T)])
    err = torch.zeros([amb(T)])
    mu = pyro.sample('mu'.format(''), dist.Normal(torch.tensor(0.0)*torch.ones([amb(1)]),torch.tensor(10.0)*torch.ones([amb(1)])))
    phi = pyro.sample('phi'.format(''), dist.Normal(torch.tensor(0.0)*torch.ones([amb(1)]),torch.tensor(2.0)*torch.ones([amb(1)])))
    nu[1-1]=mu+phi*mu
    err[1-1]=y[1-1]-nu[1-1]
    theta = pyro.sample('theta'.format(''), dist.Normal(torch.tensor(0.0)*torch.ones([amb(1)]),torch.tensor(2.0)*torch.ones([amb(1)])))
    for t in range(2, T+1):
        nu[t-1]=mu+phi*y[t-1-1]+theta*err[t-1-1]
        err[t-1]=y[t-1]-nu[t-1]
    sigma = pyro.sample('sigma'.format(''), dist.Cauchy(torch.tensor(0.0)*torch.ones([amb(1)]),torch.tensor(5.0)*torch.ones([amb(1)])))
    pyro.sample('obs__100'.format(), dist.Normal(0.0,sigma), obs=err)
    
def guide(y,T):
    arg_1 = pyro.param('arg_1', torch.ones((amb(1))), constraint=constraints.positive)
    arg_2 = pyro.param('arg_2', torch.ones((amb(1))))
    arg_3 = pyro.param('arg_3', torch.ones((amb(1))), constraint=constraints.positive)
    mu = pyro.sample('mu'.format(''), dist.StudentT(df=arg_1,loc=arg_2,scale=arg_3))
    arg_4 = pyro.param('arg_4', torch.ones((amb(1))))
    arg_5 = pyro.param('arg_5', torch.ones((amb(1))), constraint=constraints.positive)
    phi = pyro.sample('phi'.format(''), dist.Cauchy(arg_4,arg_5))
    arg_6 = pyro.param('arg_6', torch.ones((amb(1))), constraint=constraints.positive)
    arg_7 = pyro.param('arg_7', torch.ones((amb(1))), constraint=constraints.positive)
    theta = pyro.sample('theta'.format(''), dist.Pareto(arg_6,arg_7))
    for t in range(2, T+1):
        pass
    arg_8 = pyro.param('arg_8', torch.ones((amb(1))))
    arg_9 = pyro.param('arg_9', torch.ones((amb(1))), constraint=constraints.positive)
    sigma = pyro.sample('sigma'.format(''), dist.LogNormal(arg_8,arg_9))
    
    pass
    return { "mu": mu,"theta": theta,"phi": phi,"sigma": sigma, }
optim = Adam({'lr': 0.05})
svi = SVI(model, guide, optim, loss=Trace_ELBO() if pyro.__version__ > '0.1.2' else 'ELBO')
for i in range(4000):
    loss = svi.step(y,T)
    if ((i % 1000) == 0):
        print(loss)
for name in pyro.get_param_store().get_all_param_names():
    print(('{0} : {1}'.format(name, pyro.param(name).data.numpy())))
print('mu_mean', np.array2string(dist.StudentT(pyro.param('arg_1')).mean.detach().numpy(), separator=','))
print('theta_mean', np.array2string(dist.Pareto(pyro.param('arg_6'), pyro.param('arg_7')).mean.detach().numpy(), separator=','))
print('phi_mean', np.array2string(dist.Cauchy(pyro.param('arg_4'), pyro.param('arg_5')).mean.detach().numpy(), separator=','))
print('sigma_mean', np.array2string(dist.LogNormal(pyro.param('arg_8'), pyro.param('arg_9')).mean.detach().numpy(), separator=','))
np.set_printoptions(threshold=np.inf)
with open('samples','w') as samplefile:
    samplefile.write('mu:')
    samplefile.write(np.array2string(np.array([guide(y,T)['mu'].data.numpy() for _ in range(1000)]), separator=',').replace('\n',''))
    samplefile.write('\n')
    samplefile.write('theta:')
    samplefile.write(np.array2string(np.array([guide(y,T)['theta'].data.numpy() for _ in range(1000)]), separator=',').replace('\n',''))
    samplefile.write('\n')
    samplefile.write('phi:')
    samplefile.write(np.array2string(np.array([guide(y,T)['phi'].data.numpy() for _ in range(1000)]), separator=',').replace('\n',''))
    samplefile.write('\n')
    samplefile.write('sigma:')
    samplefile.write(np.array2string(np.array([guide(y,T)['sigma'].data.numpy() for _ in range(1000)]), separator=',').replace('\n',''))
    samplefile.write('\n')
