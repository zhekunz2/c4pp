import pyro, numpy as np, torch, pyro.distributions   as dist, torch.nn as nn
from pyro.optim import Adam
import torch.distributions.constraints as constraints
from pyro.infer import SVI
if pyro.__version__ > '0.1.2': from pyro.infer import Trace_ELBO
from pyro.contrib.autoguide import *
import math
def amb(x):
    return x.data.numpy().tolist() if isinstance(x, torch.Tensor) else x
y= np.array([10.0787617157, -9.51866467444, 9.73922587306, 11.5662681884, 9.62798489, -9.6026509012, 8.90114345923, 10.866328444, 10.5347883361, 8.60577222464, -10.6252274286, -9.08615131315, -8.99280046532, 9.43533905967, 8.92696803963, 9.64230128801, 9.42066621558, 9.9083840612, 9.63911912487, 7.5558512238, 9.58069898236, 9.63228461457, -9.99589804304, 8.61024296515, -10.4988882191, -8.45028703712, 9.76066425343, -8.68129886943, 9.83763492226, 7.29698608457, 8.78881675784, 10.6057117461, 10.2807363791, 9.54352982844, -10.9911972453, 12.2061931601, 7.76887153467, 10.7523541088, -9.9852555102, 10.6248182699, 10.9092322101, 9.85276119503, 10.9778885179, 10.4521386036, 10.9501292675, 8.78767098907, 10.4760680578, -10.5254343757, 10.1066471852, 8.98960108796, 11.1788924241, 8.16177207287, 8.78778163499, 9.22771109934, -10.1948463842, -10.295282008, -9.50335957628, 9.99524569311, 9.7965451999, 10.6998634278, 10.3014073262, 8.33668631497, -9.03423870378, 9.64018036967, 11.6691504373, 10.941349201, -11.2272839145, 10.8911157938, 9.46898499012, -9.5887646442, 11.1152849921, 10.1955967101, 11.3485703, 10.1358977192, 11.5544531837, 9.86110328373, 9.87931976177, 10.7522782117, 10.3312880632, 8.39765486916, 9.22717521673, 8.87715287722, 10.3908345995, 8.87861997542, 9.93346546639, 10.995625467, -9.28529380868, 9.86324177715, -11.4437979353, -9.19387673641, -11.7398350783, -10.4013203095, -10.2875824888, 9.88100959522, 10.2244248321, 8.87616842642, 11.0817433201, 11.2615426236, 10.8182260738, 10.5190581651, 9.38550490079, 12.8278076961, 11.5003104207, -8.97369784174, 9.16657709169, 10.4418149946, -9.36841324191, -10.5804663985, 10.1647431036, 9.72644824358, 10.4764027144, 10.731150603, 9.26382891182, 11.3043847535, 10.4198438028, -9.91726516629, -10.483882474, 11.109305848, -8.83241303607, 10.0804581453, 10.0910117151, 10.3553007043, 8.45462629128, 9.95894202953, -9.18454036443, 10.8157285064, 9.65495165729, 10.0482461317, -10.9056407751, -9.98443651907, 8.73484067101, 8.37862639984, -9.40580349855, -10.270315244, 11.4642739555, 11.5768548855, 7.33318938831, 10.0390903991, 11.0785766571, 8.47690794543, 9.77532169954, 9.71319992159, 10.2670182524, -10.6411181561, -9.53554022933, 12.004881988, 11.0682941124, -10.04761122, 10.7297692475, -10.00358027, 10.8842322393, 9.90100942917, 7.9581183444, 12.0537464017, 10.6148585771, 11.7695557843, -10.1622575512, 10.3283274641, -9.21930070795, -10.981205622, -10.1415857318, -11.256248953, 11.5359251228, 8.79455692191, 8.04628480806, 9.57003526472, 10.539067461, -10.0102587652, 9.71633254445, 10.2646183029, 9.28031810912, 9.52545784205, 9.87544219275, 8.93741938562, 11.9649315861, 8.22806692774, 10.9095230556, 8.12095747855, 8.69662320766, 11.1747826075, 10.143984716, -8.69217223828, -11.8049757738, 10.3501059451, 9.65514462518, 10.3322565976, -11.1729836028, 8.5092369635, 8.85788948911, 10.2092991197, 10.162159503, 10.0081847236, 9.56129159516, -10.4432066821, 9.87368142487, -9.93494898961, 10.8181022046, -8.36565834151, 10.1723657998, 10.1379422169, 10.8148837227, -9.62070693292, -10.3107408759, 10.6741558699, -11.6418647499, -10.9885637415, 10.1749081876, 11.7678771112, -9.89794804172, -10.2874581716, 9.16539086201, 11.7156318788, -10.6625885123, 11.1781349786, 10.3244312552, 10.0642081985, 11.5602518174, 10.3443603036, 8.7591172598, 8.94722796805, 9.56956921793, -10.1309504794, -9.51478854659, 9.92835907794, 12.2328395893, 10.4175852097, 11.1799855378, 11.6944884582, -11.1979346264, 10.5990249225, 8.46531130904, 8.09287304941, -10.4349607396, 10.033450286, 9.86348976237, 11.2800118873, 10.1429977591, 9.16583583953, 9.48731652642, 8.09480196743, 11.5068749882, 8.32051497776, 10.9777036311, 11.1807577803, -9.44231502565, 10.190404684, -10.9821472074, 10.9878405189, -9.55217339161, 9.26481707287, 10.1825896458, 10.8219756005, 10.1008165456, 10.7628687748, 9.92090390937, 10.6579628249, -9.61545628377, -8.99519566102, 9.39510546534, 11.3911257929, 9.6867867777, 9.56606734906, 10.7776928224, -9.03554593316, 12.5210794022, 10.6033297905, -10.571650147, -11.4702828898, 8.26263836327, 11.2634731903, -9.97665531906, -12.7159252945, -8.81471074857, 10.9835498543, -10.0566727607, -9.59343549056, -11.3094299496, -10.7066912869, -8.96610833006, 11.0242007344, 10.8491427937, -9.26175745003, 8.66365511806, 10.3606786467, 10.1390993507, -10.3545920058, -9.81176114668, 8.94812420534, -7.84729915691, -11.1097393427, -8.97049177792, -8.62284525025, -9.08518894812, 9.18235800538, 9.59052674566, 11.1088826237, 12.0591150514, -11.0780344934, -11.2223319682, -10.711444696, 9.81632041095, 10.2374039921, -8.62076386764, 10.6788651819, 8.53465451311, 8.86231220324, 9.01034391877, -9.4720112173, 10.2530108947, -10.4620363576, 9.41425920571, -9.86297844816, -11.2996452388, 11.1129580428, 11.6065794209, -9.19786212395, 11.634552926, -11.3447009402, 11.5155259029, 9.86108612467, 8.46155458967, 9.05533744799, 9.42108459009, 10.6101411197, 9.98698524478, 8.57328785962, 11.026577912, 10.2118052909, 9.48822006919, -9.70967432551, 11.4895755423, 9.45484497569, -10.192610255, 8.23195215242, 10.6262098035, -10.6548353134, 10.7406569549, 12.0080438835, -9.46193541988, 9.45842990535, 8.40313954146, 11.7578057915, -9.04913262501, 9.26991967712, 11.4560385077, 11.0485057783, -9.79982269427, 9.43726689017, -10.7568675398, 9.62310645557, 10.9180308554, 9.78569200991, -11.1549186595, 10.0163780919, 8.85676742497, 11.070187312, -10.8284383814, 9.34520294856, -8.58355914738, 9.04614723399, 9.97518990139, -10.4668222523, 10.7149245846, 9.56415807741, -8.18057472664, 8.35838095761, 10.6741185264, -9.48454403118, 11.028368421, 9.39414416764, 9.44591964129, 9.71871039605, 8.76829165383, 11.307542417, -8.75164149425, -10.2470782304, 9.81658069941, 9.92193671669, 9.95871616032, -10.1675238559, 9.55277984252, 11.9529156964, 10.8645790878, 11.0719248954, 8.23682452502, -10.2615184127, -10.3031776241, 9.15189893638, 9.01113204653, -11.4416873733, 7.95371933161, -10.7424822396, -10.390980247, 9.82362803838, 9.04852235838, -8.5017273689, 10.2821312886, 8.05606153755, 9.55880006007, 11.5791596182, -10.5918842177, 10.6690084835, -9.91207574283, 7.7821317456, 11.4331784789, 9.25405144119, 10.4530454882, 8.79853723396, 10.6006725712, -7.40422816215, 12.2912539439, 9.28522123052, 10.6514510507, 8.06040110464, 10.2065839058, 12.1107919012, 11.0899790631, 10.4114337565, 9.52050648747, 9.8233262449, 13.0390334058, 9.5790926506, 9.44804501018, 9.37477275171, -10.0180868587, 10.3969627282, 10.1736869695, -8.9312410422, 10.4419298185, 8.73384842581, 9.68372417466, 10.0969584869, -9.51083893907, 8.94918229986, 9.76536158968, -9.75804592354, 9.3728001322, 9.54544737525, -10.6553786962, 8.20866218171, 6.95463607002, -9.12229173302, -10.3922309126, 10.1911800674, 10.811118929, -10.7508305958, 9.89537312442, 9.30449381772, 10.0031444123, -12.0565376308, -10.1541745028, 10.8459935213, 9.37595699943, 10.8847432961, -8.87146124283, -10.4196432683, 9.45191183401, 10.3304971855, 9.24652569281, 11.1651379599, -11.4112140062, -7.43486236915, 9.72067399642, -10.5655378187, 10.1821841466, -9.11928490265, 11.5545470773, 8.26222672814, -8.15659176706, 11.1319957519, 9.97556499012, 9.10361465583, 9.60994307716, 8.92135187556, 10.9645697062, -10.7477667053, -11.0374524779, 8.94972532369, 8.88611506235, 11.352246427, 10.7886286988, 7.75211984082, -9.15236690548, 12.5250783808, 8.98359790097, 8.2793466629, 7.74804606379, -10.7389817587, -10.0977651329, 10.9297634009, -9.04293634192, -9.44066582532, 10.9612816498, -10.1939803096, -9.91366506535, 10.0022054779, 9.65317642713, 9.51413820147, 10.2167373078, 8.85151358441, -10.2868515649, 10.0119293803, 9.99071995497, 9.69762244615, 10.4923550217, 9.39728038247, 9.31772348034, 10.2867372374, 10.1655863563, 9.15794606452, 9.17788628123, 8.5706491756, 10.1347417193, -9.38606645005, 11.1205353766, 10.9222581273, -11.403416293, 10.7963936702, 7.32613210003, 9.77181002251, 10.0528228619, 10.1658214065, 9.83561702642, 12.222058088, -10.3548551011, 10.9045238862, 8.70700033723, 7.9219705201, 10.7627920481, 8.2313378874, 7.90747212901, 11.0409370394, -7.31593919592, 9.12670771537, -9.89974533326, -12.3025125167, -8.82410513715, 8.50745180008, 9.86128675906, -10.0026561459, 9.96643873994, 9.79259331982, 9.80917563613, 12.0569547006, 9.34882661869, -9.9144213445, -9.61223097137, 9.95007932523, 11.7469087737, 10.4001946876, 10.5559784764, 12.0789513191, 9.31096813616, -7.82775583218, 9.40240583716, 9.93255289266, 8.88142505948, -9.07668641102, -10.9109119648, 8.52931417681, 8.66414238142, 10.6497793291, -11.6580335729, 8.00698900123, 9.66953768525, 10.4132524629, 8.91281566635, -9.21143362032, 9.35679234139, -8.17615110803, 10.2081246803, -10.971565897, 13.023596733, -11.2636561659, -11.2782655062, 9.53363135009, 10.4197837528, 9.5848924412, 11.1685570712, 10.7933711281, 10.3806972167, 10.3350541573, 10.4605243372, 9.94626676686, -10.3400801867, 10.2229556096, 8.27010830457, -9.84308741185, 9.57082901043, 10.2216458443, 10.6827977409, 10.3421678349, -11.0248281303, 9.05151360162, 9.77537449605, 7.81716286622, 11.0632011096, 9.3169416976, 9.35703856931, 11.8372172616, 10.6948112204, 8.92360937535, 10.4592036914, -10.145945861, 10.1386438855, 11.232261753, 11.8305096547, 10.3184106729, 10.773853808, 9.37037543377, -10.4304860108, 9.18693348679, 11.2637648341, 8.68434565721, 9.1862019753, 11.4599611446, 10.4800031253, -11.0945574089, 10.2387376491, 9.59364694537, -8.99327095928, 8.83506298266, -10.3840194427, 10.2240609113, -10.5248893736, 9.6276078576, 10.0793650635, -10.7687001286, 10.16374377, 9.8056710217, 9.70754719844, 10.6162073474, 10.5610155839, 7.82789601788, 8.20523486137, 10.5882338382, 8.42742784923, -10.9903876114, -7.72292297951, 9.88854076082, 8.33821478475, 9.32939312308, 10.8006195512, 11.1011193107, -10.1099261, 10.8839234028, -9.92532887825, -9.91868157364, 9.61565565992, 10.1156170783, 9.69285116606, 9.31774783705, 10.4354172739, 10.250775217, 12.2559617446, 9.36685785603, -10.4170817286, -10.4898160138, 9.12436733726, 9.73098278865, 10.6828691426, 11.4304351639, 9.62265106404, -11.6792916399, 10.2603961418, 11.2480384713, 10.7788459105, 9.96903554756, -9.20629682555, 9.33979133996, 10.9270575622, 11.0235867536, 8.78292038933, 10.174986327, 9.34660106794, 12.0151338126, 10.2235037117, 8.71495972475, -10.9257631531, -8.40638278002, -11.4159669203, 10.3075336827, 11.1494528257, -9.36604661013, 12.5160741401, 10.9221895473, 8.2067968996, 8.41288957699, 9.95714952987, -8.18851913715, 10.3875227633, -9.49964095055, 8.29652826535, 11.1452130604, 9.61133393133, 9.80245365211, 12.5922520873, 11.2871470934, -9.81522553481, 10.0062190534, 9.33814985029, 9.65318392303, 11.3397324486, 10.5924192662, 10.7189040164, 9.58858072236, -8.93595486746, 10.9020304831, 10.2126174533, 9.73654043086, 9.16829715456, 8.80933690602, 8.65260186996, -9.83420909356, 10.4751631904, 9.48306706223, 10.7032794934, -10.5340316593, -8.68734920388, 10.0993895639, 10.2610910117, -10.3498244614, 11.7878492223, 11.1395681711, 9.7229946982, -11.1341460778, 11.4917828433, 9.96689142289, 9.95304472516, 8.08536614398, -10.6508106382, 10.0594483093, 8.84993284848, 10.0044806747, -8.52480932842, 10.6710460727, -10.4253298311, -11.6389314732, 10.3838794239, -10.7787002086, -10.4162764799, 10.3147107148, 9.29074853315, 10.4294665746, -9.79715019185, -9.59815986624, 10.5650236905, 8.69592570012, 10.5924173589, -8.59647478034, 9.77059656717, 9.19862131679, 9.46815770373, 10.5350232318, -12.0856331662, 7.62977295514, -9.92902480043, 11.8725972674, -11.1169060702, 8.64875216755, 9.31377194553, 10.8023045519, -10.380856078, 8.38035043472, -8.73444373055, -8.56892169012, -9.82402964738, 10.3314711584, 10.1854736755, 11.6740735051, 9.69110524374, 12.0127425726, 9.00779168174, -9.65400953289, 9.36081029524, 9.19222268308, 9.56776982984, -9.18473040612, 8.60607449535, -9.66827478103, 12.6011743606, 10.6376999885, 9.76079732069, 12.1453450842, 11.0301708481, 11.1364735782, -10.2447515836, 10.1083484589, -7.53823422256, 9.09928083429, -10.5175522522, -9.55660613596, -9.67189486763, 10.2248931038, 11.5505459402, 11.7984204539, 9.12713331251, -10.449159939, 9.41473403925, 10.0912250749, 9.83068226118, 10.8793515341, -9.78210140159, 10.5144839428, 10.394584215, -11.0409626304, 10.588672856, 10.1584352541, 9.47184598842, 8.40935619444, -9.90894751957, 8.97688134622, 11.2110199352, 10.7491856594, 10.7873017495, 10.1867756325, 9.74078386314, 9.25211168599, 9.73027150109, -10.7090076216, 10.399448456, 9.81579127086, 9.81191557692, 9.96373020802, 11.3183603457, 9.62939867216, -10.4711625257, -11.6249314545, 10.3882388393, 10.9521395154, 9.24051133273, 10.442527574, 9.87650089222, 9.29171319085, 8.91139651258, 8.57139819901, 9.99614245017, -9.85990550795, 9.70758313675, 9.50393041778, 12.0663244126, 11.6591804853, -11.4953826938, -9.27835730303, 8.95086190617, 11.2400894968, 10.3107789188, -10.4179760516, 9.13536125728, 10.9592471554, 10.9626621472, 9.04760635394, 10.8004882587, -10.2262244851, 9.22893569923, -10.4561314128, -10.6621156208, -9.79050903429, 9.47318635449, -8.00116935968, -10.0570763312, -9.19645984539, -10.0441212741, 11.4788232731, -9.4331886685, -9.35091566404, 8.528950334, 10.3534781327, 10.8276184772, 9.93337089247, -11.0344276672, 10.5590713711, 8.99583556553, 10.8999084829, -11.144277303, 9.69869203817, -8.90585531136, -11.5624306546, 10.2447855556, 10.0827199393, 9.95961077092, 10.7566861863, 11.7205344293, 9.77358643907, 10.1095239104, 10.5382421565, 10.0772574026, 9.53819581618, 10.7659953599, 11.6698787711, 10.9089919456, -10.4081150203, -9.2465775995, -9.20335463378, -10.7590681521, 10.0616808307, -8.09562344191, 11.2170830677, -9.78116905663, -8.85504543834, -10.1235456851, 9.67787506856, 8.8934394917, -7.99575653561, -10.7719795703, -11.1788890736, -10.569679874, -8.24517915453, -11.7753693142, -10.2097669134, -11.2340440813, 10.2859904418, 9.63724726837, 9.17954799126, -8.33022093177, -10.3953466788, 10.4900275191, -12.7678707807, 11.1058750469, 10.5081007689, 8.76865008136, 9.40406788246, 11.0709345717, 9.3535943224, -9.52410557964, 9.66609177641, 11.2851482152, 9.89469099484, -9.97808771307, 9.58070093523, 8.73895045272, 10.085277537, 10.1071144759, -9.70645851905, -10.7172305311, 9.30759157964, 6.96315753053, 11.3145194334, 10.3547912463, 10.4793171985, 11.6449389205, -9.38344241403, 10.7724131736, -11.3673240395, 11.0498119637, 9.15761537839, 10.051498819, 11.5409534254, 11.0837643113, 7.13879481801, 9.80309472627, -11.0768582653, -10.1153934052, 10.2030259406, 10.6349590758, 10.3643448424, -10.56952568, 8.97628386871, -7.63805118941, 9.01328532414, -9.70228671644, 10.8489734196, 10.8097332206, -8.78098406667, 10.6881885522, 9.99759635978, -9.14677074634, 11.1882650947, 7.92936829043, 8.2804528224, 9.94656850295, 9.42421871899, 10.3022543509, 9.42637476373, 11.4966226812, -9.40317552427, -9.63377150564, -9.90684687613, 9.52516052943, 8.31384015077, 11.8427680273, -9.43061137227, -9.74288461737, 9.13603951858, 9.53615106697, -11.5305542491, 9.62683068208, 11.0372608635, 9.66985167128, 11.274789536, 9.66646205027, -11.4198760102, 9.21373329527, 10.6594703226, -9.85683654391, -9.28952032751, 10.7624268604, 8.29988657733, -10.6390998021, -10.6627107314], dtype=np.float32).reshape(1000,1)
y=torch.tensor(y)
N=1000
N=torch.tensor(N)
def model(y,N):
    mu = torch.zeros([amb(2)])
    theta = pyro.sample('theta'.format(''), dist.Uniform(torch.tensor(0.0)*torch.ones([amb(1)]),torch.tensor(1.0)*torch.ones([amb(1)])))
    log_theta = torch.zeros([amb(1)])
    log_one_minus_theta = torch.zeros([amb(1)])
    log_theta=torch.log(theta)
    log_one_minus_theta=torch.log(1.0-theta)
    for k in range(1, 2+1):
        with pyro.iarange('mu_range_{0}'.format(k), 2):
            mu[k-1] = pyro.sample('mu{0}'.format(k-1), dist.Normal(torch.tensor(0.0)*torch.ones([]),torch.tensor(10.0)*torch.ones([])))
    for n in range(1, N+1):
    
def guide(y,N):
    mu = torch.zeros([amb(2)])
    arg_1 = pyro.param('arg_1', torch.ones((amb(1))))
    arg_2 = pyro.param('arg_2', torch.ones((amb(1))))
    theta = pyro.sample('theta'.format(''), dist.Uniform(arg_1,arg_2))
    for k in range(1, 2+1):
        arg_3 = pyro.param('arg_3', torch.ones(()))
        arg_4 = pyro.param('arg_4', torch.ones(()), constraint=constraints.positive)
        with pyro.iarange('mu_prange'):
            mu[k-1] = pyro.sample('mu{0}'.format(k-1), dist.LogNormal(arg_3,arg_4))
        pass
    for n in range(1, N+1):
        pass
    
    pass
    return { "mu": mu,"theta": theta, }
optim = Adam({'lr': 0.05})
svi = SVI(model, guide, optim, loss=Trace_ELBO() if pyro.__version__ > '0.1.2' else 'ELBO')
for i in range(4000):
    loss = svi.step(y,N)
    if ((i % 1000) == 0):
        print(loss)
for name in pyro.get_param_store().get_all_param_names():
    print(('{0} : {1}'.format(name, pyro.param(name).data.numpy())))
print('mu_mean', np.array2string(dist.LogNormal(pyro.param('arg_3'), pyro.param('arg_4')).mean.detach().numpy(), separator=','))
print('theta_mean', np.array2string(dist.Uniform(pyro.param('arg_1'), pyro.param('arg_2')).mean.detach().numpy(), separator=','))
np.set_printoptions(threshold=np.inf)
with open('samples','w') as samplefile:
    samplefile.write('mu:')
    samplefile.write(np.array2string(np.array([guide(y,N)['mu'].data.numpy() for _ in range(1000)]), separator=',').replace('\n',''))
    samplefile.write('\n')
    samplefile.write('theta:')
    samplefile.write(np.array2string(np.array([guide(y,N)['theta'].data.numpy() for _ in range(1000)]), separator=',').replace('\n',''))
    samplefile.write('\n')
